Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.01-py3

%files
    . /proteinae/

%environment
    export PATH=/opt/miniconda/envs/proteinae/bin:$PATH
    export CONDA_PREFIX=/opt/miniconda/envs/proteinae
    export LD_LIBRARY_PATH=/opt/miniconda/envs/proteinae/lib:$LD_LIBRARY_PATH
    export PYTHONNOUSERSITE=1

%post
    echo "[INFO] Updating apt cache"
    apt-get update || true
    apt-get install -y \
        libglib2.0-0 \
        ca-certificates \
        wget \
        git \
        tar \
        bzip2 || true

    echo "[INFO] Installing Miniconda"
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/miniconda
    rm /tmp/miniconda.sh
    export PATH=/opt/miniconda/bin:$PATH

    echo "[INFO] Configuring Conda to avoid defaults"
    conda config --system --set always_yes yes
    conda config --system --remove channels defaults || true
    conda config --system --add channels conda-forge
    conda config --system --add channels nvidia
    conda config --system --add channels bioconda
    conda config --system --add channels https://conda.rosettacommons.org

    echo "[INFO] Creating Conda environment from environment.yaml"
    conda env create -f /proteinae/environment.yaml
        

    echo "[INFO] Cleaning up"
    conda clean -afy

   echo "[INFO] downloading checkpoint"
   mkdir -p /proteinae/checkpoints
   wget https://hf-mirror.com/lisn519010/ProteinAE_v1/resolve/main/ae_r1_d8_v1.ckpt -O /proteinae/checkpoints/ae_r1_d8_v1.ckpt


%runscript

%labels
    Version v1.0
